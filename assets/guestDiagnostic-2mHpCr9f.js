import{a as D,e as q}from"./index-sS2zdJxz.js";function E(o){const a=[];return o.questions.forEach((s,n)=>{var c,r;const e=o.responses[s.id];e?a.push({id:n+1,topic:e.topic||s.topic||"",student_answer:e.student_answer||"A",correct_answer:e.correct_answer||s.correct_answer||"A",is_correct:e.is_correct!==void 0?e.is_correct:e.student_answer===s.correct_answer,confidence:e.confidence&&e.confidence>=1&&e.confidence<=5?e.confidence:3,explanation:e.explanation||"",time_spent_seconds:e.time_spent_seconds||((c=o.timeSpent)==null?void 0:c[s.id])||0}):a.push({id:n+1,topic:s.topic||"",student_answer:"A",correct_answer:s.correct_answer||"A",is_correct:!1,confidence:3,explanation:"",time_spent_seconds:((r=o.timeSpent)==null?void 0:r[s.id])||0})}),a}async function A(){var o,a,s,n,e,c,r,p;try{const t=localStorage.getItem("guest_diagnostic"),m=localStorage.getItem("guest_quiz");if(!t||!m)return console.log("[GUEST_DIAGNOSTIC] No guest diagnostic or quiz found"),{success:!1,error:"No guest diagnostic or quiz found"};let l,d;try{l=JSON.parse(t),d=JSON.parse(m)}catch(T){return console.error("[GUEST_DIAGNOSTIC] Error parsing guest data:",T),{success:!1,error:"Invalid guest diagnostic data"}}const I=l.diagnostic||l,g=E(d);let u=d.totalTime||0;if(!u&&d.timeSpent&&(u=Object.values(d.timeSpent).reduce((f,G)=>f+(G||0),0)/60),!u&&((o=l.quizData)!=null&&o.totalTime)&&(u=l.quizData.totalTime),!I||!g||g.length===0)return console.error("[GUEST_DIAGNOSTIC] Invalid diagnostic or questions list"),{success:!1,error:"Invalid diagnostic data"};const i={subject:"Mathematics",total_questions:g.length,time_taken:u,questions_list:g,diagnostic:I};console.log("[GUEST_DIAGNOSTIC] Saving guest diagnostic to account..."),console.log("[GUEST_DIAGNOSTIC] Request body:",{subject:i.subject,total_questions:i.total_questions,time_taken:i.time_taken,questions_list_length:i.questions_list.length,has_diagnostic:!!i.diagnostic});const S=await D.post(q.ai.saveDiagnostic,i);console.log("[GUEST_DIAGNOSTIC] Diagnostic saved successfully:",S.data);const _=((a=S.data)==null?void 0:a.quiz_id)||((n=(s=S.data)==null?void 0:s.diagnostic)==null?void 0:n.quiz_id);return _&&(localStorage.setItem("latest_quiz_id",_),console.log("[GUEST_DIAGNOSTIC] Updated latest_quiz_id to:",_)),localStorage.removeItem("guest_diagnostic"),localStorage.removeItem("guest_quiz"),localStorage.removeItem("guest_quiz_complete"),localStorage.removeItem("guest_banner_dismissed"),console.log("[GUEST_DIAGNOSTIC] Cleared guest diagnostic data from localStorage"),{success:!0,quizId:_}}catch(t){return console.error("[GUEST_DIAGNOSTIC] Error saving guest diagnostic:",t),console.error("[GUEST_DIAGNOSTIC] Error response:",(e=t==null?void 0:t.response)==null?void 0:e.data),console.error("[GUEST_DIAGNOSTIC] Error status:",(c=t==null?void 0:t.response)==null?void 0:c.status),{success:!1,error:((p=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:p.message)||(t==null?void 0:t.message)||"Failed to save guest diagnostic"}}}export{A as saveGuestDiagnostic};
